---
title: "Modena Time Series Analysis"
output:
  html_notebook:
    toc: yes
    toc_float: yes
  word_document:
    toc: yes
  html_document:
    df_print: paged
    toc: yes
  pdf_document:
    toc: yes
---

# Introduction
This R notebook provides code to reproduce results for the paper *Effects of antimicrobial stewardship and infection prevention and control on the incidence of carbapenem resistant gram-negative infections in Modena, Italy: a non-linear time-series analysis*. 
It requires installing of necessary packages


Data and code are available at the Github repository
[via this link](https://github.com/TimLawes/modena_carbapenem_resistance)

# 1. Preliminaries
## 1.1 Install copies of required packages to private library
```{r, message=FALSE, warning=FALSE}

# Install renv for private package library if not available
if(!require(renv)){
    install.packages("renv")
}
Sys.setenv(LOCALAPPDATA=renv::paths$library())
renv::restore()
renv::activate()
```

## 1.2 Load required packages and customised plot theme
```{r, message=FALSE, warning=FALSE}

library(tidyverse) # to enable tidyverse functions
library(earth) # for MARS
library(tseries) # for working with TS data
library(tsutils) #
library(forecast) # for forcasting
library(plotmo) # plotting MARS model from earth
library(mgcv) # for GLM and GAM models
library(smooth)
library(lmtest) # comparing models 
library(stats)
library(grid)
library(lattice)
library(viridis)
library(jsonlite)
library(curl)
library(sysfonts)
library(ganttrify) # for time lines (Gantt type)
library(patchwork) # for combining different plot types
library(missForest) # for missing value imputation by random forest
source("cochrane_plot_theme.R") # imports a custom ggplot theme defined in other script
```

## 1.3 Load data and process
```{r, message=FALSE, warning=FALSE, results='hide'}

# Read in the main data
main <- read_csv ("modena_final.csv",
                  show_col_types = FALSE)

# create a new month variable in datetime form
main <- main %>% mutate(studymonth = as.POSIXct(paste("01-", Month, sep = ""), format = "%d-%b-%y"))


# Calculate incidence of infections and colonisations (non-duplicate cases per 10 000 OBDs)
main <- main %>% mutate(across(
  all_gn_bsi:crpa_co_hca_adm_swab,~./obd*10000))


# Standardise antibiotic and alcohol-based hand-rub use (DDDs or Litres per 1000 OBDs)
main <- main %>% mutate(across(abhr: fluoroquinolones, ~./obd*1000))

# create intervention time-line
timeline <-read_csv("timings.csv")
timing <- ganttrify(project = timeline,
          project_start_date = "2008-01",
          hide_wp=TRUE,
          line_end = "square",
          month_breaks= 12,
          mark_years = TRUE,
          month_number_label = FALSE,
          month_date_label = TRUE,
          font_family = "Source Sans Pro ")


# Read in bloodstream infection dataset
blood <- read_csv("bsi_mort.csv")

# Read in additional data on changes in hand hygiene adherence by speciality
hhdata <- read_csv("hh_by.csv", col_types = cols (
  speciality = col_factor(),
  directorate = col_factor()))
# Impute missing data in period 2 of hand-hygiene by speciality dataset
hand <-as.data.frame(hhdata)
hhdata.imp <-missForest(hand)
adherence2 <-hhdata.imp[["ximp"]][["adherence"]] %>% as_tibble()
hhdata2 <- cbind(hhdata,adherence2)
rm(hhdata, adherence2)
rm(hhdata.imp)

```

## 1.4 Outlier detection and time-series cleaning
```{r, message=FALSE, warning=FALSE}

```

# 2. Descriptives

# 2.1 Table 1
# 2.2 Figure 1 CRO time series
# 2.3 Figure 2 Antibiotic use
# 2.4 Figure 3 Hand hygiene improvements
```{r, message=FALSE, warning=FALSE}

# Time-series for Hand-hygiene adherence, training, and alcohol-based hand-rub use (Litres per 1000 OBDs)


t_breaks = seq(from = dmy('01-"jan"-08'), to = dmy('01-"dec"-18'), by = '12 months')


hhp1 <- ggplot(main, aes(studymonth, y= abhr))+
  geom_line(color="darkred")+
  scale_y_continuous(name="ABHR use*")+
  geom_vline(xintercept=as.POSIXct(as.Date(
     "2012-09-01")), linetype = "dotdash", 
     color="darkgrey")+
  scale_x_datetime(breaks= as.POSIXct(t_breaks),
                   date_labels="%b-%y")+
  theme(panel.grid=element_blank(), 
        axis.title.x = element_blank(),
        axis.text.x=element_blank(),
        axis.title.y= element_text(size=9))+
  theme_pnaat()

hhp2 <- ggplot(main, aes(studymonth, y= hh_adherence))+
  geom_line(color="darkred")+
  scale_y_continuous(name= "HH adherence, %",
                     limits=c(0,1), breaks=seq(0,1,0.2),
                     labels = function(y)
                       str_wrap(y, width = 5))+
  geom_vline(xintercept=as.POSIXct(as.Date(
     "2012-09-01")), linetype = "dotdash", 
     color="darkgrey")+
  scale_x_datetime(breaks= as.POSIXct(t_breaks),
                   date_labels="%b-%y")+
  theme(panel.grid=element_blank(), 
        axis.title.x = element_blank(),
        axis.text.x=element_blank(),
        axis.title.y= element_text(size=9))+
  theme_pnaat()
    

hhp3 <- ggplot(main, aes(x=studymonth, 
                         y= hh_trained))+
  geom_line()+
  scale_y_continuous(name="Staff trained, n")+
  geom_vline(xintercept=as.POSIXct(as.Date(
     "2012-09-01")), linetype = "dotdash", 
     color="darkgrey")+
  scale_x_datetime(name = "Month and year", 
                   breaks= as.POSIXct(t_breaks),
                   date_labels="%b-%y")+
  theme(panel.grid=element_blank(),
        axis.text.x = element_text(
          size = 8, angle=45, hjust = 1),
        axis.title.x = element_text(size=9),
        axis.text.y = element_text(size=8),
        axis.title.y= element_text(size=9))+ scale_color_viridis_d(option="A")+
  theme_pnaat()


# Hand-hygiene adherence by speciality and department
hhdata2$speciality <- fct_reorder2(
  hhdata2$speciality,hhdata2$period, hhdata2$adherence,
  first2, .desc=FALSE)

hhp4 <- ggplot(hhdata2, aes(
  x=period, y= speciality, fill=value))+
  geom_tile()+
  scale_y_discrete(name="Speciality")+
  scale_x_discrete(name="Intervention phase")+
  scale_fill_viridis_c(option="A", begin=0, end=1)+
  labs(fill="Adherence")+
  theme(axis.title.x = element_text(size=8),
    axis.title.y= element_text(size=8),
    axis.text.y =element_text(size=8),
    legend.title = element_text(size=8),
    legend.text = element_text(size=8))+
  theme_pnaat()



layout <- "
EEEED
AAAAD
BBBBD
CCCCD
"
hhp1 + hhp2 + hhp3 + hhp4 + timing+
  plot_layout(design = layout)

```

# 3. VARs

# 4. GAMs

# 5. MARS



```{r}
plot(cars)
```

