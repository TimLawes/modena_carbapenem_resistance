---
title: "Modena Time Series Analysis"
output:
  html_notebook:
    toc: yes
    toc_float: yes
  word_document:
    toc: yes
  html_document:
    df_print: paged
    toc: yes
  pdf_document:
    toc: yes
---

# Introduction
This R notebook provides code to reproduce results for the paper *Effects of antimicrobial stewardship and infection prevention and control on the incidence of carbapenem resistant gram-negative infections in Modena, Italy: a non-linear time-series analysis*. 
It requires installing of necessary packages


Data and code are available at the Github repository
[via this link](https://github.com/TimLawes/modena_carbapenem_resistance)

# 1. Preliminaries
## 1.1 Install copies of required packages to private library
```{r, message=FALSE, warning=FALSE}

# Install renv for private package library if not available
if(!require(renv)){
    install.packages("renv")
}

renv::restore()

```

## 1.2 Load required packages and customised plot theme
```{r, message=FALSE, warning=FALSE}

library(tidyverse) # to enable tidyverse functions
library(earth) # for MARS
library(tseries) # for working with TS data
library(tsutils) #
library(forecast) # for forcasting
library(plotmo) # plotting MARS model from earth
library(mgcv) # for GLM and GAM models
library(smooth)
library(lmtest) # comparing models 
library(stats)
library(grid)
library(lattice)
```

## 1.3 Load data and process
```{r, message=FALSE, warning=FALSE, results='hide'}

# Read in the main data
main <- read_csv ("modena_final.csv",
                  show_col_types = FALSE)

# Calculate incidence of infections and colonisations (non-duplicate cases per 10 000 OBDs)
main <- main %>% mutate(across(
  all_gn_bsi:crpa_co_hca_adm_swab,~./obd*10000))


# Standardise antibiotic and alcohol-based hand-rub use (DDDs or Litres per 1000 OBDs)
main <- main %>% mutate(across(abhr: fluoroquinolones, ~./obd*1000))

# Read in additional data
hhdata <- read_csv("hh_by.csv", col_types = cols (
  speciality = col_factor(),
  directorate = col_factor(),
  period = col_factor()))

```

## 1.4 Outlier detection and time-series cleaning
```{r, message=FALSE, warning=FALSE}

```

# 2. Descriptives
```{r, message=FALSE, warning=FALSE}

# Hand-hygiene adherence by speciality and department
hhplot <- ggplot(hhdata, aes(x=directorate, y=adherence)+
  geom_bar(aes(fill= period), position=dodge, stat="identity",
           width = 0.5) +
  coord_flip()

hhplot

waterfall(values=hhdata$adherence, labels=hhdata$directorate)
```

# 3. VARs

# 4. GAMs

# 5. MARS



```{r}
plot(cars)
```

